# æœ¬åœ° Kubernetes ç›£æ§å †ç–Š

## ğŸ—ï¸ æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Kubernetes é›†ç¾¤                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   demo-app      â”‚    â”‚ OTel Collector  â”‚                    â”‚
â”‚  â”‚                 â”‚    â”‚                 â”‚                    â”‚
â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                    â”‚
â”‚  â”‚ â”‚Java Agent   â”‚ â”‚    â”‚ â”‚Prometheus   â”‚ â”‚                    â”‚
â”‚  â”‚ â”‚(JVM æŒ‡æ¨™)   â”‚ â”‚â”€â”€â”€â”€â”¤ â”‚Receiver     â”‚ â”‚                    â”‚
â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                    â”‚
â”‚  â”‚                 â”‚    â”‚        â”‚        â”‚                    â”‚
â”‚  â”‚ /actuator/      â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                    â”‚
â”‚  â”‚ prometheus      â”‚    â”‚ â”‚Prometheus   â”‚ â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚ â”‚Exporter     â”‚ â”‚                    â”‚
â”‚           â”‚              â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                    â”‚
â”‚           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚           â”‚                       â”‚                             â”‚
â”‚           â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   Prometheus    â”‚                    â”‚
â”‚                          â”‚    Server       â”‚                    â”‚
â”‚                          â”‚                 â”‚                    â”‚
â”‚                          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                    â”‚
â”‚                          â”‚ â”‚æ™‚é–“åºåˆ—     â”‚ â”‚                    â”‚
â”‚                          â”‚ â”‚è³‡æ–™åº«       â”‚ â”‚                    â”‚
â”‚                          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                    â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                   â”‚                             â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚                          â”‚    Grafana      â”‚                    â”‚
â”‚                          â”‚                 â”‚                    â”‚
â”‚                          â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚                    â”‚
â”‚                          â”‚ â”‚Dashboard    â”‚ â”‚                    â”‚
â”‚                          â”‚ â”‚è¦–è¦ºåŒ–       â”‚ â”‚                    â”‚
â”‚                          â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚                    â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“Š ç›£æ§çµ„ä»¶èªªæ˜

### 1. **Demo App (ä½ çš„æ‡‰ç”¨ç¨‹å¼)**
- **OpenTelemetry Java Agent**: è‡ªå‹•æ”¶é›† JVM æŒ‡æ¨™
- **Spring Boot Actuator**: æä¾› `/actuator/prometheus` ç«¯é»
- **è‡ªå®šç¾©æŒ‡æ¨™**: æ¥­å‹™é‚è¼¯ç›¸é—œçš„æŒ‡æ¨™

### 2. **OpenTelemetry Collector**
- **Prometheus Receiver**: å¾ demo-app æŠ“å–æŒ‡æ¨™
- **Prometheus Exporter**: é‡æ–°æš´éœ²æŒ‡æ¨™çµ¦ Prometheus
- **è³‡æ–™è™•ç†**: æ·»åŠ æ¨™ç±¤ã€æ‰¹æ¬¡è™•ç†ç­‰

### 3. **Prometheus Server**
- **æŒ‡æ¨™æ”¶é›†**: å¾å¤šå€‹ä¾†æºæŠ“å–æŒ‡æ¨™
- **æ™‚é–“åºåˆ—è³‡æ–™åº«**: å„²å­˜æ­·å²æŒ‡æ¨™è³‡æ–™
- **æŸ¥è©¢å¼•æ“**: æ”¯æ´ PromQL æŸ¥è©¢èªè¨€

### 4. **Grafana**
- **è¦–è¦ºåŒ–**: åœ–è¡¨ã€å„€è¡¨æ¿ã€å‘Šè­¦
- **é è¨­ Dashboard**: JVMã€Spring Bootã€Kubernetes
- **è‡ªå®šç¾© Dashboard**: å°ˆé–€ç‚º demo-app è¨­è¨ˆ

## ğŸš€ å¿«é€Ÿéƒ¨ç½²

### ä¸€éµå®‰è£
```bash
./tmp_rovodev_setup_local_monitoring.sh
```

### æ‰‹å‹•å®‰è£æ­¥é©Ÿ
```bash
# 1. å®‰è£ç›£æ§å †ç–Š
chmod +x k8s/monitoring/install-monitoring.sh
./k8s/monitoring/install-monitoring.sh

# 2. å®‰è£ ServiceMonitor
kubectl apply -f k8s/monitoring/demo-app-servicemonitor.yaml

# 3. å•Ÿç”¨ OTel Collector
kubectl patch application demo-app -n argocd --type='merge' -p='{
  "spec": {
    "source": {
      "helm": {
        "parameters": [
          {"name": "otelCollector.enabled", "value": "true"},
          {"name": "otelCollector.backend", "value": "local"}
        ]
      }
    }
  }
}'
```

## ğŸ” è¨ªå•æ–¹å¼

### Grafana (ä¸»è¦è¦–è¦ºåŒ–ä»‹é¢)
```bash
kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80
```
- URL: http://localhost:3000
- ç”¨æˆ¶å: `admin`
- å¯†ç¢¼: `admin123`

### Prometheus (æŒ‡æ¨™æŸ¥è©¢)
```bash
kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090
```
- URL: http://localhost:9090

### Demo App æŒ‡æ¨™ç«¯é»
```bash
kubectl port-forward -n demo-app svc/demo-app 8080:8080
```
- URL: http://localhost:8080/actuator/prometheus

## ğŸ“ˆ é è¨­ Dashboard

å®‰è£å¾Œæœƒè‡ªå‹•å°å…¥ä»¥ä¸‹ Dashboardï¼š

1. **JVM Dashboard (ID: 4701)**
   - JVM è¨˜æ†¶é«”ä½¿ç”¨é‡
   - åƒåœ¾å›æ”¶çµ±è¨ˆ
   - åŸ·è¡Œç·’ç‹€æ…‹

2. **Spring Boot Dashboard (ID: 6756)**
   - HTTP è«‹æ±‚çµ±è¨ˆ
   - æ‡‰ç”¨ç¨‹å¼å¥åº·ç‹€æ…‹
   - è‡ªå®šç¾©æŒ‡æ¨™

3. **Kubernetes Dashboard (ID: 315)**
   - é›†ç¾¤è³‡æºä½¿ç”¨é‡
   - Pod ç‹€æ…‹
   - ç¯€é»ç›£æ§

## ğŸ”§ è‡ªå®šç¾©é…ç½®

### ä¿®æ”¹ Prometheus é…ç½®
ç·¨è¼¯ `k8s/monitoring/prometheus-values.yaml`

### æ·»åŠ æ–°çš„ Dashboard
1. åœ¨ Grafana ä¸­å‰µå»º Dashboard
2. å°å‡º JSON é…ç½®
3. æ·»åŠ åˆ° `prometheus-values.yaml` çš„ `dashboards` å€æ®µ

### é…ç½®å‘Šè­¦è¦å‰‡
åœ¨ `prometheus-values.yaml` ä¸­æ·»åŠ  `additionalPrometheusRulesMap`

## ğŸ› ï¸ æ•…éšœæ’é™¤

### æª¢æŸ¥ Pod ç‹€æ…‹
```bash
kubectl get pods -n monitoring
kubectl get pods -n demo-app
```

### æª¢æŸ¥æœå‹™ç™¼ç¾
```bash
kubectl get servicemonitor -n monitoring
```

### æŸ¥çœ‹ Prometheus ç›®æ¨™
åœ¨ Prometheus UI ä¸­è¨ªå• Status > Targets

### æª¢æŸ¥æŒ‡æ¨™æ˜¯å¦æ­£å¸¸
```bash
curl http://localhost:8080/actuator/prometheus | grep jvm_memory
```

## ğŸ“Š é‡è¦æŒ‡æ¨™èªªæ˜

### JVM æŒ‡æ¨™
- `jvm_memory_used_bytes`: JVM è¨˜æ†¶é«”ä½¿ç”¨é‡
- `jvm_gc_pause_seconds`: GC æš«åœæ™‚é–“
- `jvm_threads_live_threads`: æ´»èºåŸ·è¡Œç·’æ•¸
- `process_cpu_usage`: CPU ä½¿ç”¨ç‡

### æ‡‰ç”¨ç¨‹å¼æŒ‡æ¨™
- `http_server_requests_seconds`: HTTP è«‹æ±‚çµ±è¨ˆ
- `demo_app_post_operations_total`: è‡ªå®šç¾©æ¥­å‹™æŒ‡æ¨™
- `demo_app_file_operations_total`: æª”æ¡ˆæ“ä½œæŒ‡æ¨™

### ç³»çµ±æŒ‡æ¨™
- `node_cpu_seconds_total`: ç¯€é» CPU ä½¿ç”¨é‡
- `node_memory_MemAvailable_bytes`: å¯ç”¨è¨˜æ†¶é«”
- `kube_pod_status_phase`: Pod ç‹€æ…‹